{% extends 'base.html' %}
{% block subtitle %} {{request.session['scalar_or_3d'].title()}} Query Wizard {% endblock %}
{% block content %}
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script type="text/javascript" src="{{ static('primo/js/tablesorter-master/jquery.tablesorter.min.js') }}"></script>
<link rel="stylesheet" type="text/css" href="{{ static('primo/blue/style.css') }}" />

    {% if user == 'superadmin' %}
        <button class="submit" onclick="
              var x = document.getElementById('sql');
              if (x.style.display === 'none') {
                x.style.display = 'block';
              } else {
                x.style.display = 'none';
              }
            ">Hide/show query and results</button>

        <div id="sql">
            <br /><br />
            {{ final_sql }}
            <br /><br />
            {{ query_results[0] }}<br /><br />
            Is preview: {{ is_preview }}
        </div>
    {% endif %}

    {% if query_results %}
        {% if not is_preview %}
            <p>If these data are what you desired, click on <a href="{{ url('export_2d') }}" class="waitAndRedirect">Download CSV file</a> to get the entire result. If you do not have a user ID, please return to the <a href="{{ url('index') }}" class="waitAndRedirect">front page</a> for instructions on how to get one.</p>
            <p>Also, please note that some browsers may change the extension of the resultant file. If this is the case, please rename it to .csv.</p>

            <p><a href="{{ url('export_2d') }}">Download CSV file</a></p>
        {% endif %}

        <script type="text/javascript" >
        $(document).ready(function()
            {
                // delay three seconds then redirect to success page
                $(".waitAndRedirect").click(function(){
                    setTimeout(function() {
                        //redirect to success page
                        window.location = "/download_success/";
                    }, 3000);
                });

                $("#resultsTable").tablesorter();
            }
        );
        </script>

        {# {{final_sql}}
        <br />
        <br />
        {{query_results[0]}} #}
        <br />
        <p>Click on column headers to sort results by column. Columns can be deleted or reordered in your spreadsheet after download.</p>
        <p><strong>{{total_specimens}} specimens found.</strong></p>

        <table id="resultsTable" class="tablesorter">
        <thead>
        <tr>
            {% for metadata in specimen_metadata %}
                <th>{{metadata[1]}}</th>
            {% endfor %}
            {% for var_id in variable_labels %}
                <th>{{var_id}}</th>
            {% endfor %}
        </tr>
        </thead>
        <tbody>
        {% for row in query_results %}
        <tr>
            {% for metadata in specimen_metadata %}
                <td>{{row[metadata[0]]}}</td>
            {% endfor %}

            {# {% for variable in variable_labels: %}
                <td>{{variable}}</td>
            {% endfor %} #}
            {% for label in variable_labels %}
                {% if row[label] %}              {# The last element in the tuple
                                                    is the dictionary {variable id : variable label}. #}
                    <td>{{ row[label] }}</td> {# So print value at that location. #}
                {% else %}
                    <td></td>
                {% endif %}
            {% endfor %} {# loop over labels (columns) #}
        </tr>
        {% endfor %} {# loop over rows #}
        </tbody>
        </table>

        {% if is_preview == 'False' %}
            <p>If these data are what you desired, click on <a href="{{ url('export_2d') }}">Download CSV file</a> to get the entire result. If you do not have a user ID, please return to the <a href="{{ url('index') }}">front page</a> for instructions on how to get one.</p>
            <p>Also, please note that some browsers may change the extension of the resultant file. If this is the case, please rename it to .csv.</p>

            <p><a href="{{ url('export_2d') }}">Download CSV file</a></p>
        {% endif %}
    {% else %}
        <h3>No results were returned.</h3>
    {% endif %} {# Are/aren't results #}

{% endblock %}
