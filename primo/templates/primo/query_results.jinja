{% extends 'base.html' %}
{% block subtitle %} {{request.session['scalar_or_3d'].title()}} Query Wizard {% endblock %}
{% block content %}
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script type="text/javascript" src="{{ static('primo/js/tablesorter-master/jquery.tablesorter.min.js') }}"></script>
<div id="main-content">

    {% if query_results %}
        {% if not is_preview %}
            <p>If these data are what you desired, click on <a href="{{ url('export_2d') }}" class="waitAndRedirect">Download CSV file</a> to get the entire result. If you do not have a user ID, please return to the <a href="{{ url('index') }}" class="waitAndRedirect">front page</a> for instructions on how to get one.</p>
            <p>Also, please note that some browsers may change the extension of the resultant file. If this is the case, please rename it to .csv.</p>
            <a href="{{ url('query_3d', 'Morphologika', False) }}"  class="waitAndRedirect">Download Morphologika file  &raquo;</a>
            &nbsp;&nbsp; | &nbsp;&nbsp;
            <a href="{{ url('query_3d', 'GRFND', False) }}"  class="waitAndRedirect">Download GRFND file  &raquo;</a>
            <p><a href="{{ url('export_2d') }}" class="waitAndRedirect">Download CSV file</a></p>
        {% endif %}

        <script type="text/javascript" >
        $(document).ready(function()
            {
                // delay three seconds then redirect to success page
                $(".waitAndRedirect").click(function(){
                    setTimeout(function() {
                        //redirect to success page
                        window.location = "/download_success/";
                    }, 3000);
                });

                $("#resultsTable").tablesorter();
            }
        );
        </script>

        <p>Click on column headers to sort results by column. Columns can be deleted or reordered in your spreadsheet after download.</p>
        <p id="specimen-count"><strong>{{total_specimens}} specimens found{% if total_specimens > 5 %}, first five are displayed.{% else %}.{% endif %}</strong></p>
        <div id="table-scroll">
        <table id="resultsTable" class="tablesorter">
        <thead>
        <tr>
            {% for metadata in specimen_metadata %}
                <th>{{metadata[1]}}</th>
            {% endfor %}
            {% for label in variable_labels %}
                <th>{{label}}</th>
            {% endfor %}
        </tr>
        </thead>
        <tbody>
        {% for row in query_results %}
            {% if loop.index0 < 5 %}
                <tr>
                    {% for metadata in specimen_metadata %}
                        <td>{{row[metadata[0]]}}</td>
                    {% endfor %}

                    {% for label in variable_labels %}
                        {% if row[label] %}           {# The last element in the tuple
                                                            is the dictionary {variable id : variable label}. #}
                            <td>{{ row[label] }}</td> {# So print value at that location. #}
                        {% else %}
                            <td></td>
                        {% endif %}
                    {% endfor %} {# loop over labels (columns) #}
                </tr>
            {% endif %}
        {% endfor %} {# loop over rows #}
        </tbody>
        </table>
        </div>
        {% if is_preview == 'False' %}
            <p>If these data are what you desired, click on <a href="{{ url('export_2d') }}">Download CSV file</a> to get the entire result. If you do not have a user ID, please return to the <a href="{{ url('index') }}">front page</a> for instructions on how to get one.</p>
            <p>Also, please note that some browsers may change the extension of the resultant file. If this is the case, please rename it to .csv.</p>

            <p><a href="{{ url('export_2d') }}">Download CSV file</a></p>
        {% endif %}
    {% else %}
        <h3>No results were returned.</h3>
    {% endif %} {# Are/aren't results #}
    {% if user == 'superadmin' %}
        <div id="sql">
            <button class="submit" onclick="
              var x = document.getElementById('sql');
              if (x.style.display === 'none') {
                x.style.display = 'block';
              } else {
                x.style.display = 'none';
              }
            ">Hide query and results</button>
        
            <br /><br />
            {{ final_sql }}
            <br /><br />
            {{ query_results[0] }}<br /><br />
            {{ query_results[1] }}<br /><br />
            {{ query_results[2] }}<br /><br />
            Is preview: {{ is_preview }}
        </div>
    {% endif %}
</div>
{% endblock %}
