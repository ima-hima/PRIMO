{% extends 'base.html' %}
{% load static %}
{% block subtitle %} {{ request.session['scalar_or_3d'].title()}} Query Sample Results {% endblock %}
{% block content %}
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script type="text/javascript" src="{% static 'primo/js/tablesorter-master/jquery.tablesorter.min.js' %}"></script>
<div id="main-content">

    {% if query_results %}
        {% if preview_only %}
            <p>Here is a sample of the data you requested. If these are the data you desired, please log in or return to the <a href="{% url index %}">front page</a> for instructions on how to get access.</p>
        {% else %}
            <p>Here is a sample of the data you requested. If these are what you desired, click on the download link below to get the entire result.</p>
            <p>Please note that some browsers may change the extension of the resultant file. If this is the case, please rename it to .csv.</p>
            {% if request.session['scalar_or_3d'] == 'scalar' %}
                <p><a href="{% url export_scalar %}">Download CSV file</a></p>
            {% else %}
                <a href="{% url export_3d', 'Morphologika %}"  class="waitAndRedirect">Download Morphologika file  &raquo;</a>
                &nbsp;&nbsp; | &nbsp;&nbsp;
                <a href="{% url export_3d', 'GRFND %}"  class="waitAndRedirect">Download GRFND file  &raquo;</a>
            {% endif %}
        {% endif %}

        <script type="text/javascript" >
        $(document).ready(function()
            {
                // delay three seconds then redirect to success page
                $(".waitAndRedirect").click(function(){
                    setTimeout(function() {
                        //redirect to success page
                        window.location = "/download_success/";
                    }, 3000);
                });

                $("#resultsTable").tablesorter();
            }
        );
        </script>

        <p>Click on column headers to sort results by column. Columns can be deleted or reordered in your spreadsheet after download.</p>
        <p id="specimen-count"><strong>{{total_specimens}} specimens found{% if total_specimens > 5 %}, first five are displayed.{% else %}.{% endif %}</strong></p>
        <div id="table-scroll">
        <table id="resultsTable" class="tablesorter">
        <thead>
        <tr>
            {% for metadata in specimen_metadata %}
                <th>{{metadata[1]}}</th>
            {% endfor %}
            {% for label in request.session['variable_labels'] %}
                <th>{{label}}</th>
            {% endfor %}
        </tr>
        </thead>
        <tbody>
        {% for row in query_results %}
            {% if loop.index0 < 5 %} {# index0 because it's 0 indexed #}
                <tr>
                    {% for metadata in specimen_metadata %}
                        <td>{{row[metadata[0]]}}</td>
                    {% endfor %}

                    {% for label in request.session['variable_labels'] %}
                        {% if row[label] %}
                             {#
                             The last element in the tuple is the dictionary
                             {variable id : variable label}. So print value at
                             that location.
                             #}
                            <td>{{ row[label] }}</td>
                        {% else %}
                            <td></td>
                        {% endif %}
                    {% endfor %} {# End loop over labels (columns). #}
                </tr>
            {% endif %}
        {% endfor %} {# End loop over rows. #}
        </tbody>
        </table>
        </div>
        {% if preview_only %}
            <p>If you do not have a user ID, please return to the <a href="{% url index %}">front page</a> for instructions on how to get one.</p>
        {% else %}
            <p>If these data are what you desired, click on the download link below to get the entire results.</p>
            <p>Please note that some browsers may change the extension of the resultant file. If this is the case, please rename it to .csv.</p>
            {% if request.session['scalar_or_3d'] == 'scalar' %}
                <p><a href="{% url export_scalar %}">Download CSV file</a></p>
            {% else %}
                <a href="{% url export_3d, Morphologika %}"  class="waitAndRedirect">Download Morphologika file  &raquo;</a>
                &nbsp;&nbsp; | &nbsp;&nbsp;
                <a href="{% url export_3d, GRFND %}"  class="waitAndRedirect">Download GRFND file  &raquo;</a>
            {% endif %}
        {% endif %}
    {% else %}
        <h3>No results were returned.</h3>
    {% endif %} {# Are/aren't results #}
    {% if request.user.username == 'superadmin' %}
        <div id="sql">
            {# { request.user.username } #}
            <button class="submit" onclick="
              var x = document.getElementById('sql');
              if (x.style.display === 'none') {
                x.style.display = 'block';
              } else {
                x.style.display = 'none';
              }
            ">Hide query and results</button>

            <br /><br />
            {{ final_sql }}
            <br /><br /><br />
            <strong>First three query results:<br /></strong>
            {{ request.session.query_results }}
            {% for i in range(3) %}
                {{ query_results[i] }}<br /><br />
            {% endfor %}
            <br />
            <strong>Variable labels from request session variable:<br /></strong>
            {{ request.session['variable_labels'] }}
            <br /><br /><br />
            <strong>Preview only:</strong> {{ preview_only }}
        </div>
    {% endif %}
</div>
{% endblock %}
